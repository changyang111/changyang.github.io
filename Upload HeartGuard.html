<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒåº·å®ˆæŠ¤ - HeartGuard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', 'system-ui', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 1.25rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .status-badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; }
        .status-normal { background: #dcfce7; color: #166534; }
        .status-high { background: #fee2e2; color: #991b1b; }
        /* éšè—åŸç”Ÿæ—¶é—´è¾“å…¥æ¡†çš„å›¾æ ‡ï¼Œåšè‡ªå®šä¹‰æ ·å¼ */
        input[type="time"] { position: relative; appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body class="pb-28">

    <!-- é¡¶éƒ¨çŠ¶æ€ -->
    <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-10 px-6 py-4">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="text-red-500 text-2xl">â¤ï¸</span> å¿ƒåº·å®ˆæŠ¤
                </h1>
                <p id="clock" class="text-xs font-mono text-blue-500 font-bold mt-1">00:00:00</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-400">ä¸Šæ¬¡å¤‡ä»½</p>
                <p id="last-sync" class="text-[10px] text-slate-500 font-bold">åˆšåˆš</p>
            </div>
        </div>
    </header>

    <main class="max-w-lg mx-auto p-5 space-y-6">
        
        <!-- æœè¯è®¡åˆ’ -->
        <section class="card p-6 border border-slate-100">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-black text-slate-800">ğŸ’Š æœè¯é—¹é’Ÿ</h2>
                <div class="flex gap-2">
                    <button onclick="resetDailyStatus()" class="text-[10px] bg-slate-100 px-3 py-1.5 rounded-full text-slate-600 font-bold active:scale-95 transition">é‡ç½®æ‰“å¡</button>
                </div>
            </div>
            <div id="med-list" class="space-y-4">
                <!-- ç”±JSç”Ÿæˆ -->
            </div>
        </section>

        <!-- è¡€å‹å½•å…¥ -->
        <section class="card p-6 border border-slate-100 bg-gradient-to-br from-white to-slate-50">
            <h2 class="text-lg font-black mb-5 text-slate-800 flex items-center gap-2">
                ğŸ©º å½•å…¥è¡€å‹ 
            </h2>
            <div class="grid grid-cols-2 gap-5 mb-5">
                <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 ml-1">æ”¶ç¼©å‹ (é«˜å‹)</label>
                    <input type="number" id="systolic" pattern="\d*" placeholder="120" class="w-full bg-white border-2 border-slate-100 rounded-2xl px-4 py-4 outline-none focus:border-blue-500 text-xl font-black text-slate-700 transition">
                </div>
                <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 ml-1">èˆ’å¼ å‹ (ä½å‹)</label>
                    <input type="number" id="diastolic" pattern="\d*" placeholder="80" class="w-full bg-white border-2 border-slate-100 rounded-2xl px-4 py-4 outline-none focus:border-blue-500 text-xl font-black text-slate-700 transition">
                </div>
            </div>
            <button onclick="saveBP()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-200 active:scale-[0.98] transition">
                ä¿å­˜ä»Šæ—¥æ•°æ®
            </button>
        </section>

        <!-- è¶‹åŠ¿å›¾ -->
        <section class="card p-6">
            <h2 class="text-lg font-black mb-5 text-slate-800">æ³¢åŠ¨è¶‹åŠ¿</h2>
            <div class="relative h-48 w-full">
                <canvas id="bpChart"></canvas>
            </div>
        </section>

        <!-- å†å²è®°å½• -->
        <section class="card p-6">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-black text-slate-800">å†å²è®°å½•</h2>
                <button onclick="clearHistory()" class="text-[10px] text-red-400 font-bold">æ¸…ç©ºæ—¥å¿—æ•°æ®</button>
            </div>
            <div id="history-list" class="space-y-3 max-h-80 overflow-y-auto pr-1">
                <!-- ç”±JSç”Ÿæˆ -->
            </div>
        </section>

        <!-- æ•°æ®ç®¡ç† -->
        <div class="flex justify-center gap-4">
            <button onclick="exportData()" class="text-[10px] text-blue-500 font-bold underline">å¯¼å‡ºå¤‡ä»½æ•°æ®</button>
            <button onclick="importData()" class="text-[10px] text-slate-400 font-bold underline">å¯¼å…¥å¤‡ä»½æ•°æ®</button>
        </div>

    </main>

    <!-- æé†’å¼¹çª— -->
    <div id="notification" class="fixed top-6 left-6 right-6 bg-slate-900 text-white p-5 rounded-3xl shadow-2xl transform translate-y-[-250%] transition-all duration-700 z-50">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-500 p-2 rounded-2xl text-xl animate-bounce">ğŸ’Š</div>
                <div>
                    <p class="font-black text-lg">æ—¶é—´åˆ°ï¼</p>
                    <p class="text-xs text-slate-400 font-bold" id="notify-text"></p>
                </div>
            </div>
            <button onclick="closeNotification()" class="bg-white text-slate-900 px-5 py-2.5 rounded-2xl font-black text-sm active:scale-90 transition">å·²æœç”¨</button>
        </div>
    </div>

    <!-- è­¦æŠ¥è’™å±‚ -->
    <div id="alert-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[60] hidden p-6">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm text-center shadow-2xl">
            <div class="text-6xl mb-6">ğŸš‘</div>
            <h3 class="text-2xl font-black text-red-600 mb-3">è¡€å‹æ•°å€¼åé«˜</h3>
            <p class="text-slate-500 font-medium leading-relaxed mb-8" id="alert-msg"></p>
            <button onclick="closeAlert()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl active:scale-95 transition">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        const STORE_MEDS = 'hg_med_config';
        const STORE_BP = 'hg_bp_history';
        const STORE_DATE = 'hg_last_run';

        let meds = JSON.parse(localStorage.getItem(STORE_MEDS)) || [
            { id: 1, name: 'é«˜è¡€å‹è¯', time: '08:00', icon: 'ğŸ©º', taken: false },
            { id: 2, name: 'å¿ƒè¡€ç®¡ä¿æŠ¤', time: '08:30', icon: 'â¤ï¸', taken: false },
            { id: 3, name: 'æ·±æµ·é±¼æ²¹', time: '12:30', icon: 'ğŸŸ', taken: false }
        ];

        let history = JSON.parse(localStorage.getItem(STORE_BP)) || [];

        function save() {
            localStorage.setItem(STORE_MEDS, JSON.stringify(meds));
            localStorage.setItem(STORE_BP, JSON.stringify(history));
            document.getElementById('last-sync').innerText = new Date().toLocaleTimeString();
        }

        function renderMeds() {
            const container = document.getElementById('med-list');
            container.innerHTML = meds.map(m => `
                <div class="flex items-center justify-between p-4 border-2 ${m.taken ? 'bg-slate-50 border-slate-50' : 'bg-white border-slate-50 shadow-sm'} rounded-2xl transition-all">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl">${m.icon}</span>
                        <div>
                            <p class="font-black text-slate-800 ${m.taken ? 'line-through text-slate-400' : ''}">${m.name}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-lg">${m.time}</span>
                                <input type="time" value="${m.time}" onchange="updateTime(${m.id}, this.value)" 
                                       class="absolute w-12 opacity-0 cursor-pointer">
                                <span class="text-[10px] text-slate-300 font-bold italic underline">æ›´æ”¹</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleMed(${m.id})" 
                        class="px-6 py-2.5 rounded-2xl text-sm font-black transition-all active:scale-90
                        ${m.taken ? 'bg-green-500 text-white shadow-lg shadow-green-100' : 'bg-slate-800 text-white shadow-lg shadow-slate-200'}">
                        ${m.taken ? 'âœ“' : 'æ‰“å¡'}
                    </button>
                </div>
            `).join('');
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            if (history.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-300 font-bold text-sm">æš‚æ— è®°å½•ï¼Œè¯·å¼€å§‹æµ‹é‡</div>';
                return;
            }
            container.innerHTML = [...history].reverse().map(h => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                    <div class="flex items-center gap-4">
                        <div class="h-2 w-2 rounded-full ${h.status==='high'?'bg-red-500':'bg-green-500'}"></div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">${h.date}</p>
                            <p class="font-mono font-black text-slate-700 text-lg">${h.sys} <span class="text-slate-300 font-normal">/</span> ${h.dia}</p>
                        </div>
                    </div>
                    <span class="status-badge ${h.status==='high'?'status-high':'status-normal'}">
                        ${h.status==='high'?'è¶…æ ‡':'ç†æƒ³'}
                    </span>
                </div>
            `).join('');
        }

        function updateTime(id, val) {
            meds = meds.map(m => m.id === id ? {...m, time: val} : m);
            save(); renderMeds();
        }

        function toggleMed(id) {
            meds = meds.map(m => m.id === id ? {...m, taken: !m.taken} : m);
            save(); renderMeds();
        }

        function saveBP() {
            const sys = parseInt(document.getElementById('systolic').value);
            const dia = parseInt(document.getElementById('diastolic').value);
            if(!sys || !dia) return;
            const isHigh = (sys >= 140 || dia >= 90);
            const now = new Date();
            const dateStr = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            history.push({ date: dateStr, sys, dia, status: isHigh ? 'high' : 'normal' });
            save();
            if(isHigh) {
                document.getElementById('alert-msg').innerHTML = `å½“å‰æ•°å€¼ <span class="text-red-600 font-black">${sys}/${dia}</span> å·²å±äºé«˜è¡€å‹èŒƒå›´ã€‚<br><br>å»ºè®®ï¼šé™å15åˆ†é’Ÿåé‡æµ‹ã€‚å¦‚ä¼´æœ‰å¤´æ™•ã€èƒ¸é—·ï¼Œè¯·åŠ¡å¿…è”ç³»åŒ»ç”Ÿã€‚`;
                document.getElementById('alert-modal').classList.remove('hidden');
            }
            updateChart(); renderHistory();
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
        }

        function resetDailyStatus() {
            if(confirm("ç¡®å®šè¦é‡ç½®ä»Šæ—¥æ‰€æœ‰è¯å“çš„æ‰“å¡çŠ¶æ€å—ï¼Ÿ")) {
                meds.forEach(m => m.taken = false);
                save(); renderMeds();
            }
        }

        function clearHistory() {
            if(confirm("è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰å†å²è¡€å‹æ•°æ®ã€‚ç¡®è®¤å—ï¼Ÿ")) {
                history = []; save(); renderHistory(); updateChart();
            }
        }

        function exportData() {
            const data = btoa(JSON.stringify({meds, history}));
            prompt("è¯·å¤åˆ¶ä»¥ä¸‹å¤‡ä»½ä»£ç å¹¶ä¿å­˜ï¼š", data);
        }

        function importData() {
            const data = prompt("è¯·è¾“å…¥å¤‡ä»½ä»£ç ï¼š");
            if(data) {
                try {
                    const parsed = JSON.parse(atob(data));
                    meds = parsed.meds; history = parsed.history;
                    save(); location.reload();
                } catch(e) { alert("æ•°æ®æ ¼å¼é”™è¯¯ï¼"); }
            }
        }

        let chart;
        function updateChart() {
            const ctx = document.getElementById('bpChart');
            const slice = history.slice(-7);
            const config = {
                type: 'line',
                data: {
                    labels: slice.map(h => h.date.split(' ')[0]),
                    datasets: [
                        { label: 'é«˜å‹', data: slice.map(h => h.sys), borderColor: '#ef4444', borderWidth: 4, pointBackgroundColor: '#fff', tension: 0.4 },
                        { label: 'ä½å‹', data: slice.map(h => h.dia), borderColor: '#3b82f6', borderWidth: 4, pointBackgroundColor: '#fff', tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false, min: 50, max: 200 }, x: { grid: { display: false }, border: { display: false } } }
                }
            };
            if(chart) chart.destroy();
            chart = new Chart(ctx, config);
        }

        function tick() {
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0];
            const hm = timeStr.substring(0, 5);
            document.getElementById('clock').innerText = timeStr;
            
            meds.forEach(m => {
                if(m.time === hm && !m.taken) {
                    const notify = document.getElementById('notification');
                    if(notify.style.transform !== 'translateY(0px)') {
                        document.getElementById('notify-text').innerText = `ç°åœ¨æ˜¯ ${m.time}ï¼Œè¯·è®°å¾—æœç”¨ã€${m.name}ã€‘`;
                        notify.style.transform = 'translateY(0px)';
                    }
                }
            });
            
            // è‡ªåŠ¨è·¨å¤©é‡ç½®
            const today = now.toDateString();
            if(localStorage.getItem(STORE_DATE) !== today) {
                meds.forEach(m => m.taken = false);
                localStorage.setItem(STORE_DATE, today);
                save(); renderMeds();
            }
        }

        function closeNotification() { document.getElementById('notification').style.transform = 'translateY(-250%)'; }
        function closeAlert() { document.getElementById('alert-modal').classList.add('hidden'); }

        window.onload = () => {
            renderMeds(); renderHistory(); updateChart();
            setInterval(tick, 1000);
        };
    </script>
</body>
</html>
